$(".has-error").removeClass("has-error"); //=> remove all error marks from form (remove red frame)
var has_error = "";

<% @errors.each do | id | %>
	$("#<%=id%>").parent().addClass("has-error"); //=> add error mark to form
	has_error = has_error + "<br>ERROR: <%=id%>";
<% end %> 

if (!has_error) {
	$table = $("#query_list_table_tbody");
	id = $table.find("tr").size() + 1;

	parameters = "Submitted data:";
	<% @params.each do |key, value| %>
		parameters = parameters + "<br> <%=key.upcase%>:  <%=value%>";
	<% end %> 

	$newTR = $("<tr id="+id+"><td><%=@params[:ra]%>,<%=@params[:dec]%></td><td><%=@params[:size]%></td><td></td><td></td><td>"+parameters+"</td></tr>");
	// parameters' td should be hidden originaly, but a pop up must appear on mouseover

	var multi_select = $('<select/>',{
		id: 'multi_select_resource'+id,
		multiple: 'multiple',
		style: 'float:center',
		name: 'source_'+id+'[]'
	});

	var delete_button = $('<a/>',
    {
        class: 'btn btn-danger btn-xs',
        style: 'height:20px',
        text: '',
        click: function () {
        	$(this).closest("tr").remove();
         }
    });

	var trash_icon = $('<i/>',{class: 'fa fa-trash-o fa-fw '});
	delete_button.prepend(trash_icon);

	$newTR.find("td").last().prev().prev().append(multi_select);
	$newTR.find("td").last().prev().append(delete_button);

	var config = {
	buttonWidth: '400px',
	buttonClass: 'btn btn-default btn-sm',
	includeSelectAllOption: true,
	enableFiltering: true,
	maxHeight: 200,
	checkboxName: '',
	filterPlaceholder: 'Search',
	selectedClass: null,
	onChange: function(option, checked) {	                    
            var selectedOptions = multi_select.find('option:selected');
				if (selectedOptions.length == 0) {
	        	multi_select.multiselect('select', option.val());
	     	}
            
        }
	}

	multi_select.multiselect(config);

	var data = new Array();
	<% sources = Rails.cache.read("sia_sources") %>
	<% sources.each do | key, value | %>
		var hash = { 
	    	label: "<%= key[0] %>",
	    	value: "<%= value[0] %>"
		};
		data.push(hash);
	<% end %>


	multi_select.multiselect('dataprovider', data);

	$table.append($newTR);
}
else {
	$("#query-form-panel-body").append(has_error); //=> if theres an error, it's printed
}